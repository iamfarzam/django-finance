{% extends "base/app.html" %}
{% load i18n %}

{% block title %}{% translate "Settings" %}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="settingsPage()" x-init="init()">
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">{% translate "Settings" %}</h1>
        <p class="mt-1 text-sm text-gray-500">{% translate "Manage your account preferences." %}</p>
    </div>

    <div class="space-y-6">
        <!-- Profile Settings -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200" x-data="profileForm()">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">{% translate "Profile Settings" %}</h2>
                <p class="mt-1 text-sm text-gray-500">{% translate "Update your personal information." %}</p>
            </div>
            <form @submit.prevent="saveProfile" class="p-6 space-y-4">
                <!-- Success message -->
                <div x-show="success" x-transition class="rounded-md bg-success-50 p-4">
                    <div class="flex">
                        <svg class="h-5 w-5 text-success-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <p class="ml-3 text-sm font-medium text-success-800">{% translate "Profile updated successfully!" %}</p>
                    </div>
                </div>
                <!-- Error message -->
                <div x-show="error" x-transition class="rounded-md bg-danger-50 p-4">
                    <div class="flex">
                        <svg class="h-5 w-5 text-danger-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <p class="ml-3 text-sm font-medium text-danger-800" x-text="error"></p>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="first_name" class="block text-sm font-medium text-gray-700">{% translate "First name" %}</label>
                        <input type="text" name="first_name" id="first_name" x-model="firstName"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="last_name" class="block text-sm font-medium text-gray-700">{% translate "Last name" %}</label>
                        <input type="text" name="last_name" id="last_name" x-model="lastName"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                    </div>
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">{% translate "Email" %}</label>
                    <input type="email" name="email" id="email" value="{{ user.email }}" disabled
                           class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 shadow-sm sm:text-sm">
                    <p class="mt-1 text-xs text-gray-500">{% translate "Contact support to change your email address." %}</p>
                </div>
                <div class="pt-4">
                    <button type="submit" :disabled="saving"
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50">
                        <svg x-show="saving" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <span x-text="saving ? 'Saving...' : 'Save Changes'"></span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Security Settings -->
        <div id="security" class="bg-white shadow-sm rounded-lg border border-gray-200" x-data="{ showPasswordModal: false }">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">{% translate "Security" %}</h2>
                <p class="mt-1 text-sm text-gray-500">{% translate "Manage your password and security preferences." %}</p>
            </div>
            <div class="p-6">
                <button @click="showPasswordModal = true" type="button" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    {% translate "Change Password" %}
                </button>
            </div>

            <!-- Change Password Modal -->
            <div x-show="showPasswordModal"
                 x-cloak
                 class="fixed inset-0 z-50 overflow-y-auto"
                 aria-labelledby="modal-title"
                 role="dialog"
                 aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <!-- Background overlay -->
                    <div x-show="showPasswordModal"
                         x-transition:enter="ease-out duration-300"
                         x-transition:enter-start="opacity-0"
                         x-transition:enter-end="opacity-100"
                         x-transition:leave="ease-in duration-200"
                         x-transition:leave-start="opacity-100"
                         x-transition:leave-end="opacity-0"
                         @click="showPasswordModal = false"
                         class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

                    <!-- Modal panel -->
                    <div x-show="showPasswordModal"
                         x-transition:enter="ease-out duration-300"
                         x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                         x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                         x-transition:leave="ease-in duration-200"
                         x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                         x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                         x-data="changePasswordForm()"
                         class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                        <div>
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-primary-100">
                                <svg class="h-6 w-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:mt-5">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                    {% translate "Change Password" %}
                                </h3>
                                <p class="mt-2 text-sm text-gray-500">
                                    {% translate "Enter your current password and choose a new one." %}
                                </p>
                            </div>
                        </div>

                        <!-- Success message -->
                        <div x-show="success" class="mt-4 rounded-md bg-success-50 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-success-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-success-800">{% translate "Password changed successfully!" %}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Error message -->
                        <div x-show="error" class="mt-4 rounded-md bg-danger-50 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-danger-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-danger-800" x-text="error"></p>
                                </div>
                            </div>
                        </div>

                        <form @submit.prevent="submit" class="mt-5 space-y-4" x-show="!success">
                            <div>
                                <label for="current_password" class="block text-sm font-medium text-gray-700">{% translate "Current Password" %}</label>
                                <input type="password" x-model="currentPassword" id="current_password" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                                       :class="{ 'border-danger-300': errors.current_password }">
                                <p x-show="errors.current_password" class="mt-1 text-sm text-danger-600" x-text="errors.current_password"></p>
                            </div>
                            <div>
                                <label for="new_password" class="block text-sm font-medium text-gray-700">{% translate "New Password" %}</label>
                                <input type="password" x-model="newPassword" id="new_password" required minlength="12"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                                       :class="{ 'border-danger-300': errors.new_password }">
                                <p class="mt-1 text-xs text-gray-500">{% translate "Minimum 12 characters with uppercase, lowercase, number, and symbol." %}</p>
                                <p x-show="errors.new_password" class="mt-1 text-sm text-danger-600" x-text="errors.new_password"></p>
                            </div>
                            <div>
                                <label for="new_password_confirm" class="block text-sm font-medium text-gray-700">{% translate "Confirm New Password" %}</label>
                                <input type="password" x-model="newPasswordConfirm" id="new_password_confirm" required
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                                       :class="{ 'border-danger-300': errors.new_password_confirm }">
                                <p x-show="errors.new_password_confirm" class="mt-1 text-sm text-danger-600" x-text="errors.new_password_confirm"></p>
                            </div>

                            <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                                <button type="submit"
                                        :disabled="loading"
                                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:col-start-2 sm:text-sm disabled:opacity-50">
                                    <svg x-show="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                    </svg>
                                    <span x-text="loading ? 'Changing...' : 'Change Password'"></span>
                                </button>
                                <button type="button"
                                        @click="showPasswordModal = false; reset()"
                                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                                    {% translate "Cancel" %}
                                </button>
                            </div>
                        </form>

                        <!-- Close button after success -->
                        <div x-show="success" class="mt-5">
                            <button type="button"
                                    @click="showPasswordModal = false; reset()"
                                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:text-sm">
                                {% translate "Close" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Preferences -->
        <div id="notifications" class="bg-white shadow-sm rounded-lg border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">{% translate "Notification Preferences" %}</h2>
                <p class="mt-1 text-sm text-gray-500">{% translate "Choose how you want to be notified." %}</p>
            </div>

            <!-- Loading state -->
            <div x-show="loadingPreferences" class="p-6">
                <div class="animate-pulse space-y-4">
                    <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                    <div class="h-10 bg-gray-200 rounded"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/4"></div>
                    <div class="h-10 bg-gray-200 rounded"></div>
                </div>
            </div>

            <div x-show="!loadingPreferences" class="divide-y divide-gray-200">
                <!-- Account Notifications -->
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 flex items-center">
                                <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-primary-100 mr-2">
                                    <svg class="h-4 w-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                </span>
                                {% translate "Account" %}
                            </h3>
                            <p class="mt-1 text-sm text-gray-500">{% translate "Login alerts, password changes, and account updates." %}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "In-app" %}</span>
                            <button type="button"
                                    @click="togglePreference('account', 'in_app_enabled')"
                                    :class="preferences.account?.in_app_enabled ? 'bg-primary-600' : 'bg-gray-200'"
                                    class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                <span :class="preferences.account?.in_app_enabled ? 'translate-x-5' : 'translate-x-0'"
                                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "Email" %}</span>
                            <button type="button"
                                    @click="togglePreference('account', 'email_enabled')"
                                    :class="preferences.account?.email_enabled ? 'bg-primary-600' : 'bg-gray-200'"
                                    class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                <span :class="preferences.account?.email_enabled ? 'translate-x-5' : 'translate-x-0'"
                                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "Frequency" %}</span>
                            <select @change="updateFrequency('account', $event.target.value)"
                                    :value="preferences.account?.email_frequency || 'immediate'"
                                    class="text-sm border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="immediate">{% translate "Immediate" %}</option>
                                <option value="daily">{% translate "Daily" %}</option>
                                <option value="weekly">{% translate "Weekly" %}</option>
                                <option value="never">{% translate "Never" %}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Finance Notifications -->
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 flex items-center">
                                <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-success-100 mr-2">
                                    <svg class="h-4 w-4 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </span>
                                {% translate "Finance" %}
                            </h3>
                            <p class="mt-1 text-sm text-gray-500">{% translate "Transactions, transfers, and balance updates." %}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "In-app" %}</span>
                            <button type="button"
                                    @click="togglePreference('finance', 'in_app_enabled')"
                                    :class="preferences.finance?.in_app_enabled ? 'bg-primary-600' : 'bg-gray-200'"
                                    class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                <span :class="preferences.finance?.in_app_enabled ? 'translate-x-5' : 'translate-x-0'"
                                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "Email" %}</span>
                            <button type="button"
                                    @click="togglePreference('finance', 'email_enabled')"
                                    :class="preferences.finance?.email_enabled ? 'bg-primary-600' : 'bg-gray-200'"
                                    class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                <span :class="preferences.finance?.email_enabled ? 'translate-x-5' : 'translate-x-0'"
                                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "Frequency" %}</span>
                            <select @change="updateFrequency('finance', $event.target.value)"
                                    :value="preferences.finance?.email_frequency || 'immediate'"
                                    class="text-sm border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="immediate">{% translate "Immediate" %}</option>
                                <option value="daily">{% translate "Daily" %}</option>
                                <option value="weekly">{% translate "Weekly" %}</option>
                                <option value="never">{% translate "Never" %}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Social Notifications -->
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 flex items-center">
                                <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-warning-100 mr-2">
                                    <svg class="h-4 w-4 text-warning-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                </span>
                                {% translate "Social" %}
                            </h3>
                            <p class="mt-1 text-sm text-gray-500">{% translate "Debts, settlements, and group expenses." %}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "In-app" %}</span>
                            <button type="button"
                                    @click="togglePreference('social', 'in_app_enabled')"
                                    :class="preferences.social?.in_app_enabled ? 'bg-primary-600' : 'bg-gray-200'"
                                    class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                <span :class="preferences.social?.in_app_enabled ? 'translate-x-5' : 'translate-x-0'"
                                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "Email" %}</span>
                            <button type="button"
                                    @click="togglePreference('social', 'email_enabled')"
                                    :class="preferences.social?.email_enabled ? 'bg-primary-600' : 'bg-gray-200'"
                                    class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                <span :class="preferences.social?.email_enabled ? 'translate-x-5' : 'translate-x-0'"
                                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "Frequency" %}</span>
                            <select @change="updateFrequency('social', $event.target.value)"
                                    :value="preferences.social?.email_frequency || 'immediate'"
                                    class="text-sm border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="immediate">{% translate "Immediate" %}</option>
                                <option value="daily">{% translate "Daily" %}</option>
                                <option value="weekly">{% translate "Weekly" %}</option>
                                <option value="never">{% translate "Never" %}</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- System Notifications -->
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 flex items-center">
                                <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-gray-100 mr-2">
                                    <svg class="h-4 w-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </span>
                                {% translate "System" %}
                            </h3>
                            <p class="mt-1 text-sm text-gray-500">{% translate "Announcements, maintenance, and feature updates." %}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "In-app" %}</span>
                            <button type="button"
                                    @click="togglePreference('system', 'in_app_enabled')"
                                    :class="preferences.system?.in_app_enabled ? 'bg-primary-600' : 'bg-gray-200'"
                                    class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                <span :class="preferences.system?.in_app_enabled ? 'translate-x-5' : 'translate-x-0'"
                                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "Email" %}</span>
                            <button type="button"
                                    @click="togglePreference('system', 'email_enabled')"
                                    :class="preferences.system?.email_enabled ? 'bg-primary-600' : 'bg-gray-200'"
                                    class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                                <span :class="preferences.system?.email_enabled ? 'translate-x-5' : 'translate-x-0'"
                                      class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">{% translate "Frequency" %}</span>
                            <select @change="updateFrequency('system', $event.target.value)"
                                    :value="preferences.system?.email_frequency || 'immediate'"
                                    class="text-sm border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="immediate">{% translate "Immediate" %}</option>
                                <option value="daily">{% translate "Daily" %}</option>
                                <option value="weekly">{% translate "Weekly" %}</option>
                                <option value="never">{% translate "Never" %}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Currency Preferences -->
        <div class="bg-white shadow-sm rounded-lg border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">{% translate "Preferences" %}</h2>
                <p class="mt-1 text-sm text-gray-500">{% translate "Customize your experience." %}</p>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-900">{% translate "Default Currency" %}</p>
                        <p class="text-sm text-gray-500">{% translate "Currency used for new accounts and transactions." %}</p>
                    </div>
                    <select class="mt-1 block w-32 rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                        <option value="USD" selected>USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="INR">INR</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="bg-white shadow-sm rounded-lg border border-danger-200">
            <div class="p-6 border-b border-danger-200 bg-danger-50">
                <h2 class="text-lg font-medium text-danger-900">{% translate "Danger Zone" %}</h2>
                <p class="mt-1 text-sm text-danger-600">{% translate "Irreversible and destructive actions." %}</p>
            </div>
            <div class="p-6">
                <button type="button" class="inline-flex items-center px-4 py-2 border border-danger-300 shadow-sm text-sm font-medium rounded-md text-danger-700 bg-white hover:bg-danger-50">
                    {% translate "Delete Account" %}
                </button>
                <p class="mt-2 text-xs text-gray-500">{% translate "Once you delete your account, there is no going back. Please be certain." %}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
function profileForm() {
    return {
        firstName: '{{ user.first_name|escapejs }}',
        lastName: '{{ user.last_name|escapejs }}',
        saving: false,
        success: false,
        error: '',

        async saveProfile() {
            this.saving = true;
            this.success = false;
            this.error = '';

            try {
                const response = await fetch('/api/v1/auth/profile/update/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN,
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        first_name: this.firstName,
                        last_name: this.lastName,
                    }),
                });

                if (response.ok) {
                    this.success = true;
                    setTimeout(() => this.success = false, 3000);
                } else {
                    const data = await response.json();
                    this.error = data.detail || data.error?.message || 'Failed to update profile.';
                }
            } catch (err) {
                console.error('Profile update error:', err);
                this.error = 'An error occurred. Please try again.';
            } finally {
                this.saving = false;
            }
        }
    };
}

function changePasswordForm() {
    return {
        currentPassword: '',
        newPassword: '',
        newPasswordConfirm: '',
        loading: false,
        success: false,
        error: '',
        errors: {},

        reset() {
            this.currentPassword = '';
            this.newPassword = '';
            this.newPasswordConfirm = '';
            this.loading = false;
            this.success = false;
            this.error = '';
            this.errors = {};
        },

        async submit() {
            this.error = '';
            this.errors = {};

            // Client-side validation
            if (this.newPassword !== this.newPasswordConfirm) {
                this.errors.new_password_confirm = 'Passwords do not match.';
                return;
            }

            if (this.newPassword.length < 12) {
                this.errors.new_password = 'Password must be at least 12 characters.';
                return;
            }

            this.loading = true;

            try {
                const response = await fetch('/api/v1/auth/password/change/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN,
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        current_password: this.currentPassword,
                        new_password: this.newPassword,
                        new_password_confirm: this.newPasswordConfirm,
                    }),
                });

                const data = await response.json();

                if (response.ok) {
                    this.success = true;
                } else {
                    // Handle validation errors
                    if (data.current_password) {
                        this.errors.current_password = Array.isArray(data.current_password)
                            ? data.current_password[0]
                            : data.current_password;
                    }
                    if (data.new_password) {
                        this.errors.new_password = Array.isArray(data.new_password)
                            ? data.new_password.join(' ')
                            : data.new_password;
                    }
                    if (data.new_password_confirm) {
                        this.errors.new_password_confirm = Array.isArray(data.new_password_confirm)
                            ? data.new_password_confirm[0]
                            : data.new_password_confirm;
                    }
                    if (data.detail) {
                        this.error = data.detail;
                    }
                    if (data.error?.message) {
                        this.error = data.error.message;
                    }
                    if (!this.error && Object.keys(this.errors).length === 0) {
                        this.error = 'Failed to change password. Please try again.';
                    }
                }
            } catch (err) {
                console.error('Password change error:', err);
                this.error = 'An error occurred. Please try again.';
            } finally {
                this.loading = false;
            }
        }
    };
}

function settingsPage() {
    return {
        loadingPreferences: true,
        preferences: {
            account: { in_app_enabled: true, email_enabled: true, email_frequency: 'immediate' },
            finance: { in_app_enabled: true, email_enabled: true, email_frequency: 'immediate' },
            social: { in_app_enabled: true, email_enabled: true, email_frequency: 'immediate' },
            system: { in_app_enabled: true, email_enabled: true, email_frequency: 'immediate' },
        },

        init() {
            this.loadPreferences();
            // Handle hash navigation
            const hash = window.location.hash;
            if (hash === '#notifications' || hash === '#security') {
                setTimeout(() => {
                    document.getElementById(hash.substring(1))?.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        },

        async loadPreferences() {
            try {
                const response = await fetch('/api/v1/notifications/preferences/', {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'same-origin',
                });
                if (response.ok) {
                    const json = await response.json();
                    // API returns {"data": [...]} - convert to object keyed by category
                    const prefsArray = json.data || json.results || (Array.isArray(json) ? json : []);
                    prefsArray.forEach(pref => {
                        this.preferences[pref.category] = pref;
                    });
                }
            } catch (error) {
                console.error('Failed to load preferences:', error);
            } finally {
                this.loadingPreferences = false;
            }
        },

        async togglePreference(category, field) {
            const current = this.preferences[category]?.[field] ?? true;
            const newValue = !current;

            // Optimistic update
            if (!this.preferences[category]) {
                this.preferences[category] = {};
            }
            this.preferences[category][field] = newValue;

            try {
                await fetch(`/api/v1/notifications/preferences/${category}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN,
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ [field]: newValue }),
                });
            } catch (error) {
                console.error('Failed to update preference:', error);
                // Revert on error
                this.preferences[category][field] = current;
            }
        },

        async updateFrequency(category, frequency) {
            if (!this.preferences[category]) {
                this.preferences[category] = {};
            }
            this.preferences[category].email_frequency = frequency;

            try {
                await fetch(`/api/v1/notifications/preferences/${category}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.CSRF_TOKEN,
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ email_frequency: frequency }),
                });
            } catch (error) {
                console.error('Failed to update frequency:', error);
            }
        }
    };
}
</script>
{% endblock %}
